CREATE TABLE Usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome_de_usuario VARCHAR(50) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    email VARCHAR(100)
);


-- Criação da tabela Equipe
CREATE TABLE Equipe (
    ID_Equipe INT AUTO_INCREMENT PRIMARY KEY,
    Nome_Equipe VARCHAR(50) NOT NULL,
    Nome_Completo_Equipe VARCHAR(100) NOT NULL,
    Cidade VARCHAR(50),
    Estado VARCHAR(50),
    Treinador VARCHAR(50),
    Estadio VARCHAR(100)
);

CREATE TABLE Estadio (
    ID_Estadio int AUTO_INCREMENT PRIMARY KEY,
    EquipeID INT,
    Nome_Estadio VARCHAR(100),
    Capacidade INT,
    C_Estadio VARCHAR(50),
    FOREIGN key (Nome_Estadio) REFERENCES Equipe (Estadio)
    FOREIGN KEY (EquipeID) REFERENCES Equipe(ID_Equipe),
    FOREIGN KEY (C_Estadio) REFERENCES Equipe(Cidade)
);

-- Criação da tabela Jogador
CREATE TABLE Atleta (
    ID_Atleta INT AUTO_INCREMENT PRIMARY KEY,
    Nome_Atleta VARCHAR(30) NOT NULL,
    Posicao VARCHAR(50),
    DataNascimento DATE,
    Nacionalidade VARCHAR(50),
    NumeroCamisa INT,
    EquipeID INT,
    GOLS INT,
    JOGOS INT,
    CA INT,
    CV INT,
    FOREIGN KEY (EquipeID) REFERENCES Equipe(ID_Equipe)
);

-- Criação da tabela Partida

CREATE TABLE Partidas (
    ID_Partida INT AUTO_INCREMENT PRIMARY KEY,
    Rodada INT,
    DiaHora DATETIME NOT NULL,
    EquipeMandanteID INT,
    EquipeVisitanteID INT,
    Estadio_Partida VARCHAR(100),
    GolsMandante INT,
    GolsVisitante INT,
    FOREIGN KEY (EquipeMandanteID) REFERENCES Equipe(ID_Equipe),
    FOREIGN KEY (EquipeVisitanteID) REFERENCES Equipe(ID_Equipe)
);

DROP TABLE Partidas;


-- Criação da tabela EstatisticasPartida
CREATE TABLE Estatisticas_Partida (
    ID_Estat INT AUTO_INCREMENT PRIMARY KEY,
    PartidaID INT,
    AtletaID INT,
    Gols_Pro INT,
    Gols_Contra INT,
    Amarelos INT,
    Vermelhos INT,
    FOREIGN KEY (PartidaID) REFERENCES Partida(ID_Partida),
    FOREIGN KEY (AtletaID) REFERENCES Atleta(ID_Atleta)
);

CREATE TABLE Tabela_Brasileirao (
    POS INT AUTO_INCREMENT PRIMARY KEY,
    EquipeID INT,
    Pts INT,
    Jogos INT,
    Vitoria INT,
    Empate INT,
    Derrota INT,
    GP INT,
    GC INT,
    SG INT,
    CA INT,
    CV INT,
    FOREIGN KEY (EquipeID) REFERENCES Equipe(ID_Equipe)
);

-- Criação da tabela Artilheiro
CREATE TABLE Artilheiro (
    ID_Artilheiro INT AUTO_INCREMENT PRIMARY KEY,
    AtletaID INT,
    Gols INT,
    FOREIGN KEY (AtletaID) REFERENCES Atleta(ID_Atleta)
);

-- Criação da tabela EquipeFairPlay
CREATE TABLE Equipe_FairPlay (
    ID_FairPlay INT AUTO_INCREMENT PRIMARY KEY,
    EquipeID INT,
    PontuacaoFairPlay INT,
    FOREIGN KEY (EquipeID) REFERENCES Equipe(ID_Equipe)
);

-- Criação da tabela EquipeMaisViolenta
CREATE TABLE Equipe_NoFairPlay (
    ID_NoFairPlay INT AUTO_INCREMENT PRIMARY KEY,
    EquipeID INT,
    PontuacaoViolencia INT,
    FOREIGN KEY (EquipeID) REFERENCES Equipe(ID_Equipe)
);


ALTER TABLE Equipe ADD Nome_Completo_Equipe VARCHAR(100) AFTER Nome_Equipe;
ALTER TABLE Equipe ADD Treinador VARCHAR(100) AFTER Estado,
ALTER TABLE Equipe ADD Estadio VARCHAR(100) AFTER Treinador;
ALTER TABLE Atleta Drop CPF;

INSERT INTO Usuarios (nome_de_usuario, senha, email) VALUES ('Admin', '12345', 'xulambs@admin.com');

INSERT INTO Equipe (Treinador, Estadio) VALUES (Fabián Bustos, Independencia);
INSERT INTO Tabela_Brasileirao ( Pts, Vitoria, Empate, Derrota, Gols_Pro, Gols_Contra, Saldo, CartoesAmarelos, CartoesVermelhos) VALUES (0,0,0,0,0,0,0,0,0);
ALTER TABLE Tabela_Brasileirao ADD Jogos INT AFTER Pts;

UPDATE Tabela_Brasileirao
SET Pts = 59, Jogos = 31, Vitoria = 18, Empate = 5, Derrota = 8, Gols_Pro = 48, Gols_Contra = 24, Saldo = 24, CartoesAmarelos = 82, CartoesVermelhos = 7
WHERE EquipeID = 1;

UPDATE Tabela_Brasileirao
SET Pts = 59, Jogos = 32, Vitoria = 17, Empate = 8, Derrota = 7, GP = 53, GC = 27, SG = 26, CA = 61, CV = 4
WHERE EquipeID = 2;
	32	17	8	7	53	27	26	92	4	61

UPDATE Equipe
SET Treinador = 'Fabián Bustos'
WHERE ID_Equipe = 1;

UPDATE Equipe
SET Estadio = 'Independência'
WHERE ID_Equipe = 1;

UPDATE Equipe
SET Treinador = 'Wesley Carvalho', Estadio = 'Ligga Arena'
WHERE ID_Equipe = 2,

UPDATE Equipe
SET Treinador = 'Luis Felipe Scolari', Estadio = 'Arena MRV'
WHERE ID_Equipe = 3;
UPDATE Equipe
SET Treinador = 'Rogerio Ceni', Estadio = 'Itaipava Arena Fonte Nova'
WHERE ID_Equipe = 4;

UPDATE Equipe
SET Treinador = 'Lucio Flávio', Estadio = 'Nilton Santos'
WHERE ID_Equipe = 5;
UPDATE Equipe
SET Treinador = 'Mano Menezes', Estadio = 'Neo Química Arena'
WHERE ID_Equipe = 6;
UPDATE Equipe
SET Treinador = 'Thiago Kosloski', Estadio = 'Couto Pereira'
WHERE ID_Equipe = 7;
UPDATE Equipe
SET Treinador = 'Zé Ricardo', Estadio = 'Mineirão'
WHERE ID_Equipe = 8;
UPDATE Equipe
SET Treinador = 'Antonio Oliveira', Estadio = 'Arena Pantanal'
WHERE ID_Equipe = 9;
UPDATE Equipe
SET Treinador = 'Tite', Estadio = 'Maracanã'
WHERE ID_Equipe = 10;
UPDATE Equipe
SET Treinador = 'Fernando Diniz', Estadio = 'Maracanã'
WHERE ID_Equipe = 11;
UPDATE Equipe
SET Treinador = 'Juan Vojvoda', Estadio = 'Castelão'
WHERE ID_Equipe = 12;
UPDATE Equipe
SET Treinador = 'Armando Evangelista', Estadio = 'Serrinha'
WHERE ID_Equipe = 13;
UPDATE Equipe
SET Treinador = 'Renato Portaluppi', Estadio = 'Arena do Gremio'
WHERE ID_Equipe = 14;
UPDATE Equipe
SET Treinador = 'Eduardo Coudet', Estadio = 'Beira Rio'
WHERE ID_Equipe = 15;
UPDATE Equipe
SET Treinador = 'Abel Ferreira', Estadio = 'Allianz Parque'
WHERE ID_Equipe = 16;
UPDATE Equipe
SET Treinador = 'Pedro Caixinha', Estadio = 'Nabi Abi Chedid'
WHERE ID_Equipe = 17;
UPDATE Equipe
SET Treinador = 'Marcelo Fernandes', Estadio = 'Vila Belmiro'
WHERE ID_Equipe = 18;
UPDATE Equipe
SET Treinador = 'Dorival Jr', Estadio = 'Morumbi'
WHERE ID_Equipe = 19;
UPDATE Equipe
SET Treinador = 'Ramón Díaz', Estadio = 'São Januário'
WHERE ID_Equipe = 20;

ALTER TABLE Tabela_Brasileirao
CHANGE COLUMN CartoesAmarelos CA INT;


CREATE VIEW Competicao
AS SELECT Nome_Equipe, Pts, Jogos, Vitoria, Empate, Derrota, GP, GC, SG, CA, CV
FROM Equipe, Tabela_Brasileirao
WHERE  



CREATE VIEW Classificacao AS
SELECT 
    EquipeID,
    SUM(Pts) AS Pontos,
    SUM(Vitoria) AS Vitoria,
    SUM(Derrota) AS Derrota,
    SUM(Empate) AS Empate,
    SUM(GP) AS GP,
    SUM(GC) AS GC,
    SUM(CV) AS CV,
    SUM(CA) AS CA
FROM Tabela_Brasileirao
GROUP BY EquipeID
ORDER BY 
    Pontos DESC, 
    Vitoria DESC, 
    (GP - GC) DESC, 
    GP DESC, 
    GC ASC, 
    CV ASC, 
    CA ASC;

CREATE VIEW Classificacao AS
SELECT 
    ROW_NUMBER() OVER (ORDER BY Pts DESC, Vitoria DESC, SG DESC, GP DESC, GC ASC, CV ASC, CA ASC) AS POS,
    E.Nome_Equipe as Nome,
    Pts,
    Jogos,
    Vitoria,
    Empate,
    Derrota,
    GP,
    GC,
    SG,
    CA,
    CV
FROM Tabela_Brasileirao T
JOIN Equipe E ON T.EquipeID = E.ID_Equipe;


TRUNCATE TABLE Tabela_Brasileirao;

DROP VIEW Classificacao;


ALTER TABLE Usuarios
CHANGE COLUMN nome_de_usuario username VARCHAR(100) NOT NULL;

ALTER TABLE Usuarios
CHANGE COLUMN senha password VARCHAR(255) NOT NULL;

ALTER TABLE Usuarios ADD nome_completo VARCHAR(255) NOT NULL AFTER email;

ALTER TABLE Usuarios 
CHANGE COLUMN nome_completo_usuario nome_completo VARCHAR(255) NOT NULL;

UPDATE Usuarios
SET nome_completo = 'Xulambs'
WHERE id = 1;

ALTER TABLE Usuarios DROP COLUMN nome_completo_usuario;

ALTER TABLE Equipe ADD Escudo BLOB AFTER Estadio;

UPDATE Equipe
SET Escudo = LOAD_FILE('/home/matheuznsilva/GitHub/TP_BD/Application/static/imagens/escudos/America-MG.png')
WHERE ID_Equipe = 1;

UPDATE Atleta SET Nome_Atleta = 'Mariano' WHERE ID_Atleta = 50;

ALTER TABLE Atleta ADD CA INT AFTER EquipeID;
ALTER TABLE Atleta ADD COLUMN GOLS INT AFTER EquipeID;
ALTER TABLE Atleta ADD COLUMN JOGOS INT AFTER GOLS;

UPDATE Atleta SET GOLS = 19 WHERE ID_Atleta = 59;

CREATE VIEW Artilheiro AS
SELECT ID_Atleta, Nome_Atleta, GOLS, JOGOS
FROM Atleta a
WHERE GOLS >= (
    SELECT DISTINCT GOLS
    FROM Atleta b
    ORDER BY GOLS DESC
    LIMIT 9, 1
) OR (
    GOLS = (
        SELECT DISTINCT GOLS
        FROM Atleta c
        ORDER BY GOLS DESC
        LIMIT 9, 1
    ) AND JOGOS < (
        SELECT MIN(JOGOS)
        FROM Atleta d
        WHERE d.GOLS = (
            SELECT DISTINCT GOLS
            FROM Atleta e
            ORDER BY GOLS DESC
            LIMIT 9, 1
        )
    )
)
ORDER BY GOLS DESC, JOGOS ASC
LIMIT 10;


CREATE VIEW Artilheiro AS
SELECT A.ID_Atleta, E.Nome_Equipe, A.Nome_Atleta, A.GOLS, A.JOGOS
FROM Atleta A
INNER JOIN Equipe E ON A.EquipeID = E.ID_Equipe
ORDER BY A.GOLS DESC
LIMIT 20;


CREATE VIEW CartoesVermelhos AS
SELECT A.ID_Atleta, E.Nome_Equipe, A.Nome_Atleta, A.CV, A.JOGOS
FROM Atleta A
INNER JOIN Equipe E ON A.EquipeID = E.ID_Equipe
ORDER BY A.CV DESC
LIMIT 20;

CREATE VIEW CartoesAmarelos AS
SELECT A.ID_Atleta, E.Nome_Equipe, A.Nome_Atleta, A.CA, A.JOGOS
FROM Atleta A
INNER JOIN Equipe E ON A.EquipeID = E.ID_Equipe
ORDER BY A.CA DESC
LIMIT 20;

ALTER TABLE Partidas ADD COLUMN Rodada INT AFTER ID_Partida;

UPDATE Partida SET Rodada = 1;

DROP TABLE Atleta;

DROP TABLE Partidas;

UPDATE Partidas
SET GolsMandante = '0', GolsVisitante = '0'
WHERE ID_Partida = 10;

